/**
 * NGワードフィルター（拡張版）
 * 表示名・bio・コメント・ユーザーハンドルに適用
 * 表記揺れ（ひらがな・カタカナ・漢字・英語・半角全角）対応
 */

// NGワードリスト
const NG_WORDS: string[] = [
  // ===== 差別・侮辱 =====
  "死ね", "しね", "シネ", "氏ね", "市ね", "タヒね", "タヒ",
  "殺す", "ころす", "コロス", "頃す", "56す",
  "消えろ", "きえろ", "キエロ",
  "ガイジ", "がいじ", "害児",
  "池沼", "知障", "知的障害",
  "きちがい", "キチガイ", "基地外", "キチ",
  "カタワ", "かたわ", "片輪",
  "めくら", "メクラ", "盲",
  "つんぼ", "ツンボ", "聾",
  "びっこ", "ビッコ",
  "乞食", "こじき", "コジキ",
  "ゴミ人間", "ごみ人間", "人間のクズ", "クズ人間",
  "ゴミクズ", "ごみくず",
  "カス野郎", "かす野郎",
  "クソ野郎", "くそ野郎",
  "うざい", "ウザい", "ウザイ", "うぜえ", "ウゼェ",
  "きもい", "キモい", "キモイ", "きめえ", "キメェ",
  "きしょい", "キショい", "キショイ",
  "ブス", "ぶす", "不細工", "ブサイク", "ぶさいく",
  "デブ", "でぶ",
  "ハゲ", "はげ", "禿",
  "チビ", "ちび",
  "くたばれ", "クタバレ",
  "アホ", "あほ", "阿呆",
  "バカ", "ばか", "馬鹿",
  "マヌケ", "まぬけ", "間抜け",
  "ボケ", "ぼけ", "惚け",
  "カス", "かす", "粕",
  "ゴミ", "ごみ",
  "クズ", "くず", "屑",
  "雑魚", "ザコ", "ざこ",
  "ニート", "にーと",
  "こどおじ", "こどおば",
  "陰キャ", "いんきゃ",
  "発達障害",
  "アスペ", "あすぺ",
  "ガチャハズレ",
  "生きる価値",
  "存在価値",
  "低脳", "低能",

  // ===== 人種・民族差別 =====
  "ニガー", "nigger", "nigga",
  "チョン", "ちょん",
  "チャンコロ", "ちゃんころ",
  "チュン", "支那", "シナ",
  "土人", "どじん",
  "白豚", "黒んぼ",
  "朝鮮人",
  "在日",

  // ===== 暴言・脅迫 =====
  "ぶっ殺", "ブッ殺", "ぶっころ", "ブッコロ",
  "死ねよ", "しねよ", "シネヨ",
  "殺すぞ", "ころすぞ", "コロスゾ",
  "殺してやる", "ころしてやる",
  "爆破", "放火",
  "自殺しろ", "自殺しな",
  "首吊れ", "首つれ",
  "飛び降りろ",
  "刺す", "さす",
  "殴る", "なぐる",
  "ぶん殴", "ブン殴",
  "ボコる", "ぼこる",
  "シバく", "しばく",
  "潰す", "つぶす",
  "地獄に落ちろ",
  "呪ってやる",
  "許さん", "ゆるさん",
  "覚えとけ",
  "調子乗んな", "調子のんな",

  // ===== 性的表現 =====
  "ちんこ", "チンコ", "チン子",
  "ちんぽ", "チンポ", "ちんぼ",
  "ちんちん", "チンチン",
  "おちんちん", "オチンチン",
  "まんこ", "マンコ", "マン子",
  "おまんこ", "オマンコ",
  "おっぱい", "オッパイ", "おぱい",
  "巨乳", "貧乳", "爆乳",
  "パイズリ", "ぱいずり",
  "フェラ", "ふぇら",
  "クンニ", "くんに",
  "手マン", "手まん", "てまん",
  "中出し", "なかだし",
  "ぶっかけ", "ブッカケ",
  "セックス", "せっくす", "SEX", "sex",
  "ハメ撮り", "はめどり",
  "オナニー", "おなにー", "オナ",
  "マスターベーション",
  "射精", "しゃせい",
  "勃起", "ぼっき",
  "レイプ", "れいぷ", "rape",
  "強姦", "ごうかん",
  "痴漢", "ちかん",
  "覗き", "のぞき", "盗撮",
  "エロ", "えろ",
  "エッチ", "えっち", "Hな",
  "変態", "へんたい", "HENTAI",
  "淫乱", "いんらん",
  "ヤリマン", "やりまん", "ヤリチン", "やりちん",
  "ビッチ", "びっち",
  "パンツ見", "パンチラ", "ぱんちら",
  "全裸", "ぜんら", "素っ裸",
  "陰毛", "いんもう",
  "陰茎", "陰部",
  "性器", "せいき",
  "風俗", "ふうぞく", "ソープ", "デリヘル", "ヘルス",
  "AV女優", "av女優",
  "援交", "えんこう", "援助交際",
  "パパ活", "ぱぱかつ", "ママ活",
  "fuck", "FUCK", "Fuck",
  "shit", "SHIT", "Shit",
  "dick", "DICK", "Dick",
  "pussy", "PUSSY", "Pussy",
  "bitch", "BITCH", "Bitch",
  "cock", "COCK",
  "asshole", "ASSHOLE",
  "motherfucker",
  "wtf", "WTF",
  "stfu", "STFU",

  // ===== 詐欺・スパム =====
  "儲かる", "もうかる", "儲ける",
  "稼げる", "かせげる", "稼ぐ方法",
  "副業", "ふくぎょう",
  "出会い系", "であいけい",
  "LINE交換", "ライン交換", "line交換",
  "カカオ交換",
  "DMください", "DM下さい", "DMちょうだい",
  "情報商材", "じょうほうしょうざい",
  "投資詐欺",
  "無料配信", "むりょうはいしん",
  "限定公開",
  "今だけ無料",
  "月収100万",
  "不労所得",
  "簡単に稼",
  "誰でも稼",

  // ===== 違法行為 =====
  "ノミ行為", "のみ行為",
  "八百長", "やおちょう",
  "裏情報", "うらじょうほう",
  "インサイダー",
  "脱税", "だつぜい",
  "マネロン", "マネーロンダリング",
  "違法賭博",
  "闇カジノ", "裏カジノ",
  "薬物", "やくぶつ",
  "大麻", "たいま", "マリファナ",
  "覚醒剤", "かくせいざい", "シャブ", "しゃぶ",
  "コカイン",
  "ヘロイン",
  "MDMA",
  "合法ハーブ",

  // ===== 競馬関連の不適切表現 =====
  "イカサマ", "いかさま",
  "出来レース", "できレース", "デキレース",
  "馬刺し", "うまさし",
  "馬肉", "うまにく",
  "犬肉",
  "動物虐待", "どうぶつぎゃくたい",
  "鞭で打て", "ムチで打て",
  "殺処分",
  "馬殺", "うまころ",
];

// 正規表現にエスケープ
function escapeRegex(str: string): string {
  return str.replace(/[.*+?^${}()|[\]\\]/g, "\\$&");
}

// NGワードの正規表現パターンを事前コンパイル
const NG_PATTERNS = NG_WORDS.map(
  (word) => new RegExp(escapeRegex(word), "i")
);

/**
 * テキストにNGワードが含まれているかチェック
 * @returns マッチしたNGワード（なければnull）
 */
export function checkNGWord(text: string): string | null {
  if (!text) return null;

  // 全角→半角変換してもチェック
  const normalized = text
    .replace(/[Ａ-Ｚａ-ｚ０-９]/g, (s) => String.fromCharCode(s.charCodeAt(0) - 0xFEE0))
    .replace(/　/g, " ");

  for (let i = 0; i < NG_WORDS.length; i++) {
    if (NG_PATTERNS[i].test(text) || NG_PATTERNS[i].test(normalized)) {
      return NG_WORDS[i];
    }
  }

  return null;
}

/**
 * 複数フィールドをまとめてチェック
 * @returns エラーメッセージ（問題なければnull）
 */
export function checkNGWords(fields: Record<string, string | null | undefined>): string | null {
  for (const [fieldName, value] of Object.entries(fields)) {
    if (!value) continue;
    const matched = checkNGWord(value);
    if (matched) {
      const label = FIELD_LABELS[fieldName] || fieldName;
      return `${label}に不適切な表現が含まれています`;
    }
  }
  return null;
}

const FIELD_LABELS: Record<string, string> = {
  display_name: "表示名",
  bio: "自己紹介",
  body: "コメント",
  comment: "コメント",
  user_handle: "ユーザーID",
};

/**
 * NGワードをマスクして返す（表示用）
 */
export function maskNGWords(text: string): string {
  if (!text) return text;

  let result = text;
  for (let i = 0; i < NG_WORDS.length; i++) {
    result = result.replace(NG_PATTERNS[i], (match) => "＊".repeat(match.length));
  }
  return result;
}
