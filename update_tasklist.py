import re

path = "TASKLIST.md"
with open(path, "r") as f:
    content = f.read()

# 1. サマリー更新: 49→58完了, 27→18未着手
content = content.replace("| ✅ 完了 | 49 |", "| ✅ 完了 | 58 |")
content = content.replace("| 🔴 未着手 | 27 |", "| 🔴 未着手 | 18 |")

# 2. 実施順序更新
content = content.replace(
    "Phase I       → コミュニティ安全性・運用 ← 次はここ\nPhase G       → 将来機能（3ヶ月〜）",
    "Phase I       → ✅ 完了（2026-02-15）\nPhase G       → 将来機能（3ヶ月〜） ← 次はここ"
)

# 3. Phase Iセクション全置換
old_phase_i = """## 🛡 Phase I: コミュニティ安全性・運用品質

> ユーザー増加に備えたモデレーション・運用ツール

| # | タスク | 説明 | 優先度 | 工数 |
|---|--------|------|--------|------|
| 64 | コメント通報機能 | 通報ボタン→理由選択→管理者に通知 | 🟠高 | 0.5日 |
| 65 | コメント編集・削除 | 自分のコメントを編集/削除可能に | 🟠高 | 0.5日 |
| 66 | ユーザーブロック機能 | ブロック→TL・コメント非表示 | 🟡中 | 1日 |
| 67 | 管理者コメント管理画面 | コメント一覧・削除・非表示・通報対応 | 🟡中 | 1日 |
| 68 | ユーザー検索 | 名前でユーザーを検索してプロフィール表示 | 🟡中 | 0.5日 |
| 69 | レースカレンダー | 週間/月間のレーススケジュール俯瞰（カレンダーUI） | 🟢低 | 1日 |
| 70 | ヘルスチェックAPI | /api/health エンドポイント。外部監視ツール連携用 | 🟡中 | 0.5日 |
| 71 | DBバックアップ戦略 | Supabase自動バックアップ設定 + 復元手順ドキュメント | 🟡中 | 0.5日 |
| 72 | ステージング環境 | Vercel Preview Deployment + 環境分離手順 | 🟡中 | 0.5日 |"""

new_phase_i = """## ✅ Phase I: コミュニティ安全性・運用品質（完了）

> ユーザー増加に備えたモデレーション・運用ツール（2026-02-15 完了）

| # | タスク | 説明 | 状態 | 完了日 |
|---|--------|------|------|--------|
| 64 | コメント通報機能 | 通報ボタン→理由選択→管理者に通知 | ✅済 | 2026-02-15 |
| 65 | コメント編集・削除 | 自分のコメントを編集/削除可能に | ✅済 | 2026-02-15 |
| 66 | ユーザーブロック機能 | ブロック→TL・コメント非表示 | ✅済 | 2026-02-15 |
| 67 | 管理者コメント管理画面 | コメント一覧・削除・非表示・通報対応 | ✅済 | 2026-02-15 |
| 68 | ユーザー検索 | 名前でユーザーを検索してプロフィール表示 | ✅済 | 2026-02-15 |
| 69 | レースカレンダー | 月間のレーススケジュール俯瞰（カレンダーUI） | ✅済 | 2026-02-15 |
| 70 | ヘルスチェックAPI | /api/health エンドポイント。外部監視ツール連携用 | ✅済 | 2026-02-15 |
| 71 | DBバックアップ戦略 | Supabase自動バックアップ設定 + 復元手順ドキュメント | ✅済 | 2026-02-15 |
| 72 | ステージング環境 | Vercel Preview Deployment + 環境分離手順 | ✅済 | 2026-02-15 |

**実装詳細:**
- コメント通報: ReportModal + /api/comments/[commentId]/report（レート制限付き、管理者通知連携）
- コメント編集・削除: 三点メニュー（⋯）からアクセス、編集済みバッジ表示、論理削除
- ブロック: /api/blocks + BlockButton。ブロック時に相互フォロー解除、TL・コメントから自動除外
- 管理者コメント管理: AdminTabs「💬コメント管理」タブ。フィルター（全て/通報あり/非表示/削除済み）+ 非表示・削除・通報対応/却下
- ユーザー検索: /users ページ + デバウンス検索 + pg_trgmインデックス
- レースカレンダー: /races/calendar 月間表示。重賞G1/G2/G3色分け、日付タップで詳細
- ヘルスチェック: DB接続チェック + レイテンシ計測。ステータス200/503
- DBバックアップ: docs/DB_BACKUP.md（pg_dump手順 + PITR設定チェックリスト）
- ステージング: docs/STAGING_ENVIRONMENT.md + StagingBannerコンポーネント（NEXT_PUBLIC_ENV連動）"""

content = content.replace(old_phase_i, new_phase_i)

# 4. 最終更新日
content = content.replace("> **最終更新: 2026-02-14**", "> **最終更新: 2026-02-15**")

# 5. 更新履歴追加
old_history = "| 2026-02-14 | Phase J 完了"
new_history = "| 2026-02-15 | Phase I 完了（コメント通報/編集/削除、ユーザーブロック、管理者コメント管理、ユーザー検索、レースカレンダー、ヘルスチェックAPI、DBバックアップ戦略、ステージング環境）。全Phase完了 58/76件 |\n| 2026-02-14 | Phase J 完了"
content = content.replace(old_history, new_history)

with open(path, "w") as f:
    f.write(content)

print("✅ TASKLIST.md 更新完了!")
print("   完了: 49 → 58 / 未着手: 27 → 18")
